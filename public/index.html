<!DOCTYPE html>
<html lang="en" class="">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Form</title>

    <!-- Tailwind is included -->
    <link rel="stylesheet" href="../css/main.css" />

    <!-- Icons below are for demo only. Feel free to use any icon pack. Docs: https://bulma.io/documentation/elements/icon/ -->
    <link
      rel="stylesheet"
      href="https://cdn.materialdesignicons.com/4.9.95/css/materialdesignicons.min.css"
    />

    <style>
      table {
        background-color: rgb(116, 116, 116);
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <nav id="navbar-main" class="navbar is-fixed-top">
        <div class="navbar-brand">
          <a class="navbar-item mobile-aside-button">
            <span class="icon"
              ><i class="mdi mdi-forwardburger mdi-24px"></i
            ></span>
          </a>
          <div class="navbar-item">
            <div class="control">
              <input placeholder="Search everywhere..." class="input" />
            </div>
          </div>
        </div>
        <div class="navbar-brand is-right">
          <a
            class="navbar-item --jb-navbar-menu-toggle"
            data-target="navbar-menu"
          >
            <span class="icon"
              ><i class="mdi mdi-dots-vertical mdi-24px"></i
            ></span>
          </a>
        </div>
        <div class="navbar-menu" id="navbar-menu">
          <div class="navbar-end">
            <div class="navbar-item dropdown has-divider has-user-avatar">
              <a class="navbar-link">
                <div class="user-avatar">
                  <img
                    src="https://avatars.dicebear.com/v2/initials/john-doe.svg"
                    alt="John Doe"
                    class="rounded-full"
                  />
                </div>
                <div class="is-user-name" id="userDisplay">Loading user...</div>
              </a>
            </div>

            <a
              title="Log out"
              href="/logout"
              class="navbar-item desktop-icon-only"
            >
              <span class="icon"><i class="mdi mdi-logout"></i></span>
              <span>Log out</span>
            </a>
          </div>
        </div>
      </nav>

      <aside class="aside is-placed-left is-expanded">
        <div class="aside-tools">
          <div>
            <div id="roleDisplay">Loading role...</div>
          </div>
        </div>
        <div class="menu is-menu-main">
          <p class="menu-label">General</p>
          <ul class="menu-list">
            <li class="--set-active-index-html">
              <a href="/admin/dashboard">
                <span class="icon"><i class="mdi mdi-desktop-mac"></i></span>
                <span class="menu-item-label">Admin Dashboard</span>
              </a>
            </li>
            <li class="--set-active-index-html">
              <a href="/dashboard">
                <span class="icon"><i class="mdi mdi-desktop-mac"></i></span>
                <span class="menu-item-label">Visitor Dashboard</span>
              </a>
            </li>
          </ul>
          <ul class="menu-list">
            <li class="active">
              <a href="/">
                <span class="icon"
                  ><i class="mdi mdi-square-edit-outline"></i
                ></span>
                <span class="menu-item-label">Forms</span>
              </a>
            </li>
            <li>
              <a href="/login">
                <span class="icon"><i class="mdi mdi-lock"></i></span>
                <span class="menu-item-label">Login</span>
              </a>
            </li>
          </ul>
          <p class="menu-label">About</p>
          <ul class="menu-list">
            <li>
              <a href="https://github.com/npma7" class="has-icon">
                <span class="icon"><i class="mdi mdi-github-circle"></i></span>
                <span class="menu-item-label">GitHub</span>
              </a>
            </li>
          </ul>
        </div>
      </aside>

      <section class="is-title-bar">
        <div
          class="flex flex-col md:flex-row items-center justify-between space-y-6 md:space-y-0"
        >
          <ul>
            <li>Visitor</li>
            <li>Forms</li>
          </ul>
        </div>
      </section>

      <section class="is-hero-bar">
        <div
          class="flex flex-col md:flex-row items-center justify-between space-y-6 md:space-y-0"
        >
          <h1 class="title">Forms</h1>
        </div>
      </section>

      <section class="section main-section">
        <div class="card">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon"><i class="mdi mdi-ballot"></i></span>
              Forms
            </p>
          </header>
          <div class="card-content">
            <form method="get" id="uploadForm">
              <div class="field">
                <label class="label">From</label>
                <div class="field-body">
                  <div class="field">
                    <div class="control icons-left">
                      <input
                        class="input"
                        type="text"
                        id="senderName"
                        placeholder="Enter your name"
                        required
                      />
                      <span class="icon left"
                        ><i class="mdi mdi-account"></i
                      ></span>
                    </div>
                  </div>
                  <div class="field">
                    <div class="control icons-left">
                      <input
                        type="file"
                        id="image"
                        name="image"
                        accept="image/*"
                        required
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div class="field grouped">
                <div class="control">
                  <button type="submit" class="button green">Submit</button>
                </div>
                <div class="control">
                  <button type="reset" class="button red">Reset</button>
                </div>
              </div>
            </form>
            <div id="upload-success-modal" class="modal">
              <div class="modal-content">
                <h4>Upload Successful</h4>
                <p>Your image has been uploaded successfully.</p>
                <div class="modal-footer">
                  <button id="close-upload-success-modal" class="button">
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <table>
        <thead>
          <tr>
            <th>Image Uploaded</th>
            <th>Sender Name</th>
            <th>Upload Date</th>
          </tr>
        </thead>
        <tbody id="imageTableBodyView">
          <!-- Gambar akan dimuat di sini -->
        </tbody>
      </table>
      <footer class="footer">
        <div
          class="flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0"
        >
          <div class="flex items-center justify-start space-x-3">
            <div>Â© 2024, npma7</div>
          </div>
        </div>
      </footer>
    </div>
    <script src="js/main.js"></script>
    <script src="js/main.min.js"></script>

    <script>
      document
        .getElementById("uploadForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const formData = new FormData();
          formData.append(
            "sender_name",
            document.getElementById("senderName").value
          );
          formData.append("image", document.getElementById("image").files[0]);

          fetch("/api/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (response.ok) {
                // Tampilkan modal setelah upload berhasil
                const modal = document.getElementById("upload-success-modal");
                const closeModalButton = document.getElementById(
                  "close-upload-success-modal"
                );

                modal.style.display = "block";

                closeModalButton.onclick = () => {
                  modal.style.display = "none";
                };

                window.onclick = (event) => {
                  if (event.target == modal) {
                    modal.style.display = "none";
                  }
                };

                // Kosongkan input form setelah berhasil upload
                document.getElementById("senderName").value = "";
                document.getElementById("image").value = "";
                loadImages(); // Muat ulang gambar setelah unggahan berhasil
                viewImages(); // Muat ulang gambar setelah unggahan berhasil
              } else {
                alert("Failed to upload image");
              }
            })
            .catch((error) => console.error("Error:", error));
        });

      function viewImages() {
        fetch("/api/images")
          .then((response) => response.json())
          .then((images) => {
            if (images.length > 0) {
              const latestImage = images[0]; // Mengambil gambar terbaru (diasumsikan gambar pertama dalam array adalah yang terbaru)
              const imageTableBody =
                document.getElementById("imageTableBodyView");
              imageTableBody.innerHTML = ""; // Kosongkan tabel

              const tr = document.createElement("tr");

              const tdImg = document.createElement("td");
              const img = document.createElement("img");
              img.src = `/api/images/${latestImage.id}`;
              img.alt = latestImage.sender_name;
              img.style.width = "200px";
              img.style.height = "100px";
              tdImg.appendChild(img);

              const tdName = document.createElement("td");
              tdName.textContent = latestImage.sender_name;

              const tdDate = document.createElement("td");
              tdDate.textContent = new Date(
                latestImage.upload_date
              ).toLocaleString();
              tr.appendChild(tdImg);
              tr.appendChild(tdName);
              tr.appendChild(tdDate);

              imageTableBody.appendChild(tr);
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      viewImages();

      async function fetchData() {
        try {
          const response = await fetch("/admin/data/user/json");
          if (response.ok) {
            const { username, role: userRole } = await response.json();
            document.getElementById("userDisplay").textContent = `${username}`;
            document.getElementById(
              "roleDisplay"
            ).textContent = `Hello, ${userRole}!`;
            if (userRole === "admin") {
              console.log("User is an admin");
            }else {
              console.log("User is an visitor");
            }
          } else {
            document.getElementById("roleDisplay").textContent = `Your Visitor`;
            document.getElementById("userDisplay").textContent = `Not login`;
          }
        } catch (error) {
          console.error("Error fetching user data:", error);
        }
      }
      
      fetchData(); 
    </script>
  </body>
</html>
